<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZELDA RIM'K - OPEN WORLD ULTRA</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #hud { position: absolute; top: 20px; left: 20px; color: white; pointer-events: none; }
        .bar-container { width: 200px; height: 12px; background: rgba(0,0,0,0.5); border: 2px solid #fff; border-radius: 6px; margin-bottom: 10px; overflow: hidden; }
        #health-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff4b2b, #ff416c); }
        #stamina-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #56ab2f, #a8e063); }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); opacity: 0.5; }
        #overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; color: gold; cursor: pointer; z-index: 10; text-align: center; }
    </style>
</head>
<body>

    <div id="hud">
        <div class="bar-container"><div id="health-fill"></div></div>
        <div class="bar-container"><div id="stamina-fill"></div></div>
        <div id="status">PLATEAU DU PRÉLUDE - HD</div>
    </div>
    <div id="crosshair"></div>
    <div id="overlay"><h1>CLIQUER POUR ENTRER DANS L'OPEN WORLD</h1></div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- SCÈNE & RENDERER ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.FogExp2(0x87CEEB, 0.02); // Brouillard réaliste

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // --- LUMIÈRES CINÉMATIQUES ---
        const ambient = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambient);

        const sun = new THREE.DirectionalLight(0xffffff, 1.2);
        sun.position.set(50, 100, 50);
        sun.castShadow = true;
        sun.shadow.mapSize.set(2048, 2048);
        scene.add(sun);

        // --- ENVIRONNEMENT ---
        const groundGeo = new THREE.PlaneGeometry(500, 500);
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x3a5f0b, roughness: 0.8 });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Ajouter des "Arbres"
        for(let i=0; i<100; i++) {
            const trunk = new THREE.Mesh(new THREE.BoxGeometry(1, 5, 1), new THREE.MeshStandardMaterial({color: 0x4d2600}));
            const leaves = new THREE.Mesh(new THREE.SphereGeometry(3, 8, 8), new THREE.MeshStandardMaterial({color: 0x1a3300}));
            trunk.position.set(Math.random()*400-200, 2.5, Math.random()*400-200);
            leaves.position.y = 4;
            trunk.add(leaves);
            trunk.castShadow = true;
            scene.add(trunk);
        }

        // --- JOUEUR ET ÉPÉE ---
        const player = new THREE.Group();
        scene.add(player);
        player.position.set(0, 1.5, 0);
        player.add(camera);

        const sword = new THREE.Mesh(
            new THREE.BoxGeometry(0.15, 1.2, 0.15),
            new THREE.MeshStandardMaterial({ color: 0x888888, metalness: 0.8, roughness: 0.2 })
        );
        sword.position.set(0.6, -0.5, -1);
        sword.rotation.x = Math.PI / 2;
        camera.add(sword);

        // --- ENNEMIS ---
        const enemies = [];
        const createBokoblin = (x, z) => {
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.5, 2, 1.5), new THREE.MeshStandardMaterial({ color: 0xbc2a1a }));
            body.position.set(x, 1, z);
            body.castShadow = true;
            body.userData = { hp: 3, speed: 0.06 };
            scene.add(body);
            enemies.push(body);
        };
        for(let i=0; i<15; i++) createBokoblin(Math.random()*100-50, Math.random()*100-50);

        // --- CONTRÔLES & LOGIQUE ---
        let keys = {}, stamina = 100, isAttacking = false;
        document.addEventListener('keydown', (e) => keys[e.code] = true);
        document.addEventListener('keyup', (e) => keys[e.code] = false);
        document.getElementById('overlay').addEventListener('click', () => document.body.requestPointerLock());

        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement) {
                player.rotation.y -= e.movementX * 0.002;
                camera.rotation.x -= e.movementY * 0.002;
                camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
            }
        });

        document.addEventListener('mousedown', () => {
            if (document.pointerLockElement && !isAttacking) {
                isAttacking = true;
                const tl = new THREE.Vector3(sword.rotation.x, sword.rotation.y, sword.rotation.z);
                // Animation simple
                sword.rotation.z += 1.5;
                setTimeout(() => { 
                    sword.rotation.z -= 1.5; 
                    isAttacking = false; 
                }, 150);

                // Raycast pour dégâts
                const ray = new THREE.Raycaster();
                ray.setFromCamera(new THREE.Vector2(), camera);
                const hits = ray.intersectObjects(enemies);
                if(hits.length > 0 && hits[0].distance < 4) {
                    hits[0].object.userData.hp--;
                    hits[0].object.position.add(ray.ray.direction.multiplyScalar(2));
                    if(hits[0].object.userData.hp <= 0) {
                        scene.remove(hits[0].object);
                        enemies.splice(enemies.indexOf(hits[0].object), 1);
                    }
                }
            }
        });

        // --- BOUCLE D'ANIMATION ---
        function animate(time) {
